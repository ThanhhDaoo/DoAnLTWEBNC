@model List<GaraMVC.Models.YeucauDichVu>

@{
    ViewData["Title"] = "Yêu cầu dịch vụ";
}

<!-- Breadcrumb -->
<div class="flex-wrap-box gap14 mb-24">
    <div class="page-title">
        <h3>Yêu cầu dịch vụ</h3>
        <ul class="breadcrumbs">
            <li><a asp-controller="Home" asp-action="Index">Dashboard</a></li>
            <li><i class="fas fa-chevron-right"></i></li>
            <li>Yêu cầu</li>
        </ul>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mb-20" role="alert">
        <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mb-20" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="wg-box">
    <div class="flex-wrap-box gap10 mb-24">
        <div class="wg-filter flex-grow">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Tìm kiếm yêu cầu..." onkeyup="filterTable()">
            </div>
        </div>
        <div class="filter-buttons" style="display:flex;gap:8px;">
            <button class="tf-button filter-btn active" data-status="all" onclick="filterByStatus('all', this)">Tất cả</button>
            <button class="tf-button filter-btn" data-status="Mới" onclick="filterByStatus('Mới', this)">Mới</button>
            <button class="tf-button filter-btn" data-status="Đang xử lý" onclick="filterByStatus('Đang xử lý', this)">Đang xử lý</button>
            <button class="tf-button filter-btn" data-status="Hoàn thành" onclick="filterByStatus('Hoàn thành', this)">Hoàn thành</button>
        </div>
    </div>

    <div class="wg-table table-responsive">
        <table class="table table-striped" id="dataTable">
            <thead>
                <tr>
                    <th>Khách hàng</th>
                    <th>Mã YC</th>
                    <th>Dịch vụ</th>
                    <th>Ngày hẹn</th>
                    <th>Giờ hẹn</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    @foreach (var item in Model)
                    {
                        var colors = new[] { "2377FC", "22C55E", "FF9F43", "7367F0", "FF5200" };
                        var colorIndex = item.MaYeuCau % 5;
                        var statusClass = item.TrangThai switch
                        {
                            "Mới" => "pending",
                            "Đang xử lý" => "info",
                            "Hoàn thành" => "success",
                            "Đã hủy" => "danger",
                            _ => "warning"
                        };
                        <tr>
                            <td>
                                <div class="product-item gap14">
                                    <div class="image">
                                        <img src="https://ui-avatars.com/api/?name=@Uri.EscapeDataString(item.TenKhachHang)&background=@colors[colorIndex]&color=fff&size=50" alt="">
                                    </div>
                                    <div class="flex flex-column">
                                        <span class="name">@item.TenKhachHang</span>
                                        <span class="text-tiny text-secondary">@item.SoDienThoai</span>
                                    </div>
                                </div>
                            </td>
                            <td><span class="fw-semibold">#YC@item.MaYeuCau</span></td>
                            <td>@(item.DichVu?.TenDichVu ?? "N/A")</td>
                            <td>@(item.NgayHen?.ToString("dd/MM/yyyy") ?? "-")</td>
                            <td>@(item.GioHen ?? "-")</td>
                            <td>
                                <span class="badge-status @statusClass">@item.TrangThai</span>
                            </td>
                            <td>
                                <div class="list-icon-function">
                                    <a asp-action="Details" asp-route-id="@item.MaYeuCau" class="item eye" title="Xem chi tiết">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    @if (item.TrangThai == "Mới")
                                    {
                                        <form method="post" action="@Url.Action("UpdateStatus", new { id = item.MaYeuCau, trangThai = "Đang xử lý" })" style="display:inline;">
                                            <button type="submit" class="item edit" title="Bắt đầu xử lý" onclick="return confirm('Xác nhận xử lý?')">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        </form>
                                    }
                                    @if (item.TrangThai == "Đang xử lý")
                                    {
                                        <form method="post" action="@Url.Action("UpdateStatus", new { id = item.MaYeuCau, trangThai = "Hoàn thành" })" style="display:inline;">
                                            <button type="submit" class="item edit" title="Hoàn thành" onclick="return confirm('Xác nhận hoàn thành?')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                    }
                                    <form method="post" action="@Url.Action("Delete", new { id = item.MaYeuCau })" style="display:inline;">
                                        <button type="submit" class="item trash" title="Xóa" onclick="return confirm('Xác nhận xóa?')">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Chưa có yêu cầu nào</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="divider"></div>
    <div class="flex-wrap-box gap10">
        <div class="text-tiny">Hiển thị @Model?.Count yêu cầu</div>
        <ul class="wg-pagination">
            <li><a href="#"><i class="fas fa-chevron-left"></i></a></li>
            <li><a href="#" class="active">1</a></li>
            <li><a href="#"><i class="fas fa-chevron-right"></i></a></li>
        </ul>
    </div>
</div>

@section Scripts {
<style>
.filter-btn {
    background: #f0f0f0;
    color: #333;
    padding: 10px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
}

.filter-btn:hover {
    background: #e0e0e0;
}

.filter-btn.active {
    background: #E8F1FF;
    color: #2377FC;
    font-weight: 600;
}
</style>

<script>
var currentStatus = 'all';

function filterTable() {
    var input = document.getElementById("searchInput");
    var filter = input.value.toLowerCase();
    var table = document.getElementById("dataTable");
    var tr = table.getElementsByTagName("tr");
    
    for (var i = 1; i < tr.length; i++) {
        var td = tr[i].getElementsByTagName("td");
        var found = false;
        
        // Kiểm tra search text
        for (var j = 0; j < td.length; j++) {
            if (td[j]) {
                var txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }
        
        // Kiểm tra status filter
        if (found && currentStatus !== 'all') {
            var statusCell = td[5]; // Cột trạng thái
            if (statusCell) {
                var statusText = statusCell.textContent.trim();
                found = statusText === currentStatus;
            }
        }
        
        tr[i].style.display = found ? "" : "none";
    }
    
    updateCount();
}

function filterByStatus(status, button) {
    currentStatus = status;
    
    // Update active button
    var buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(function(btn) {
        btn.classList.remove('active');
    });
    button.classList.add('active');
    
    // Filter table
    var table = document.getElementById("dataTable");
    var tr = table.getElementsByTagName("tr");
    var searchFilter = document.getElementById("searchInput").value.toLowerCase();
    
    for (var i = 1; i < tr.length; i++) {
        var td = tr[i].getElementsByTagName("td");
        var statusCell = td[5]; // Cột trạng thái
        
        if (statusCell) {
            var statusText = statusCell.textContent.trim();
            var matchStatus = (status === 'all' || statusText === status);
            
            // Kiểm tra cả search filter
            var matchSearch = true;
            if (searchFilter) {
                matchSearch = false;
                for (var j = 0; j < td.length; j++) {
                    if (td[j]) {
                        var txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toLowerCase().indexOf(searchFilter) > -1) {
                            matchSearch = true;
                            break;
                        }
                    }
                }
            }
            
            tr[i].style.display = (matchStatus && matchSearch) ? "" : "none";
        }
    }
    
    updateCount();
}

function updateCount() {
    var table = document.getElementById("dataTable");
    var tr = table.getElementsByTagName("tr");
    var count = 0;
    
    for (var i = 1; i < tr.length; i++) {
        if (tr[i].style.display !== "none") {
            count++;
        }
    }
    
    var countText = document.querySelector('.text-tiny');
    if (countText) {
        countText.textContent = 'Hiển thị ' + count + ' yêu cầu';
    }
}
</script>
}
