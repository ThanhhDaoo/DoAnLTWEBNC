@model List<GaraMVC.Models.LienHe>

@{
    ViewData["Title"] = "Quản lý liên hệ";
}

<!-- Breadcrumb -->
<div class="flex-wrap-box gap14 mb-24">
    <div class="page-title">
        <h3>Liên hệ</h3>
        <ul class="breadcrumbs">
            <li><a asp-controller="Home" asp-action="Index">Dashboard</a></li>
            <li><i class="fas fa-chevron-right"></i></li>
            <li>Liên hệ</li>
        </ul>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row g-3 mb-24">
    <div class="col-md-4">
        <div class="wg-box" style="padding:20px;">
            <div class="d-flex align-items-center gap-3">
                <div style="width:50px;height:50px;background:#E8F1FF;border-radius:10px;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-inbox" style="color:#2377FC;font-size:20px;"></i>
                </div>
                <div>
                    <div class="text-tiny">Tổng liên hệ</div>
                    <h4 class="mb-0 fw-bold">@Model.Count</h4>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="wg-box" style="padding:20px;">
            <div class="d-flex align-items-center gap-3">
                <div style="width:50px;height:50px;background:rgba(34,197,94,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-check-circle" style="color:#22C55E;font-size:20px;"></i>
                </div>
                <div>
                    <div class="text-tiny">Đã xử lý</div>
                    <h4 class="mb-0 fw-bold text-success">@Model.Count(x => x.DaXuLy)</h4>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="wg-box" style="padding:20px;">
            <div class="d-flex align-items-center gap-3">
                <div style="width:50px;height:50px;background:rgba(255,159,67,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-clock" style="color:#FF9F43;font-size:20px;"></i>
                </div>
                <div>
                    <div class="text-tiny">Chưa xử lý</div>
                    <h4 class="mb-0 fw-bold text-warning">@Model.Count(x => !x.DaXuLy)</h4>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="wg-box">
    <div class="flex-wrap-box gap10 mb-24">
        <div class="wg-filter flex-grow">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Tìm kiếm liên hệ..." onkeyup="filterTable()">
            </div>
        </div>
        <div class="filter-buttons" style="display:flex;gap:8px;">
            <button class="tf-button filter-btn active" data-filter="all" style="background:#E8F1FF;color:#2377FC;padding:10px 16px;border-radius:8px;border:none;">Tất cả</button>
            <button class="tf-button filter-btn" data-filter="pending" style="background:#f0f0f0;color:#333;padding:10px 16px;border-radius:8px;border:none;">Chưa xử lý</button>
            <button class="tf-button filter-btn" data-filter="done" style="background:#f0f0f0;color:#333;padding:10px 16px;border-radius:8px;border:none;">Đã xử lý</button>
        </div>
    </div>

    <div class="wg-table table-responsive">
        <table class="table table-striped" id="dataTable">
            <thead>
                <tr>
                    <th>Người gửi</th>
                    <th>Email</th>
                    <th>Chủ đề</th>
                    <th>Nội dung</th>
                    <th>Ngày gửi</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    @foreach (var item in Model)
                    {
                        var colors = new[] { "2377FC", "22C55E", "FF9F43", "7367F0", "FF5200" };
                        var colorIndex = item.MaLienHe % 5;
                        <tr data-status="@(item.DaXuLy ? "done" : "pending")" id="row-@item.MaLienHe">
                            <td>
                                <div class="product-item gap14">
                                    <div class="image">
                                        <img src="https://ui-avatars.com/api/?name=@Uri.EscapeDataString(item.HoTen)&background=@colors[colorIndex]&color=fff&size=50" alt="">
                                    </div>
                                    <div class="flex flex-column">
                                        <span class="name">@item.HoTen</span>
                                        <span class="text-tiny text-secondary">@item.SoDienThoai</span>
                                    </div>
                                </div>
                            </td>
                            <td>@item.Email</td>
                            <td><span class="fw-semibold">@item.ChuDe</span></td>
                            <td>
                                <span class="text-secondary" title="@item.NoiDung">
                                    @(item.NoiDung?.Length > 40 ? item.NoiDung.Substring(0, 40) + "..." : item.NoiDung)
                                </span>
                            </td>
                            <td>@item.NgayGui.ToString("dd/MM/yyyy")</td>
                            <td>
                                <span class="badge-status @(item.DaXuLy ? "success" : "warning")" id="badge-@item.MaLienHe" style="cursor:pointer;" onclick="toggleStatus(@item.MaLienHe, @(item.DaXuLy ? "true" : "false"))">
                                    <i class="fas @(item.DaXuLy ? "fa-check-circle" : "fa-clock") me-1"></i>
                                    @(item.DaXuLy ? "Đã xử lý" : "Chưa xử lý")
                                </span>
                            </td>
                            <td>
                                <div class="list-icon-function">
                                    <a href="#" class="item eye" title="Xem chi tiết" data-bs-toggle="modal" data-bs-target="#detailModal-@item.MaLienHe">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="#" class="item trash" title="Xóa">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-envelope fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Chưa có liên hệ nào</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="divider"></div>
    <div class="flex-wrap-box gap10">
        <div class="text-tiny">Hiển thị @Model?.Count liên hệ</div>
        <ul class="wg-pagination">
            <li><a href="#"><i class="fas fa-chevron-left"></i></a></li>
            <li><a href="#" class="active">1</a></li>
            <li><a href="#"><i class="fas fa-chevron-right"></i></a></li>
        </ul>
    </div>
</div>

@section Scripts {
<script>
function filterTable() {
    var input = document.getElementById("searchInput");
    var filter = input.value.toLowerCase();
    var table = document.getElementById("dataTable");
    var tr = table.getElementsByTagName("tr");
    
    for (var i = 1; i < tr.length; i++) {
        var td = tr[i].getElementsByTagName("td");
        var found = false;
        for (var j = 0; j < td.length; j++) {
            if (td[j]) {
                var txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }
        tr[i].style.display = found ? "" : "none";
    }
}

function toggleStatus(id, currentStatus) {
    var newStatus = !currentStatus;
    
    $.post('@Url.Action("UpdateStatus", "LienHe")', { 
        id: id, 
        daxuly: newStatus 
    }, function(res) {
        if(res.success){
            location.reload();
        }
    });
}

// Filter buttons
$('.filter-btn').click(function() {
    $('.filter-btn').removeClass('active').css({'background':'#f0f0f0','color':'#333'});
    $(this).addClass('active').css({'background':'#E8F1FF','color':'#2377FC'});
    
    var filter = $(this).data('filter');
    var rows = $('#dataTable tbody tr');
    
    rows.each(function() {
        var status = $(this).data('status');
        if (filter === 'all' || status === filter) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
});
</script>
}
